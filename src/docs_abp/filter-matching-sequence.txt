# If changed, go to https://sequencediagram.org/ to regenerate diagram
title ABP Chromium filter matching flow

participant AdblockURLLoaderThrottle (Renderer or Browser)
participant AdblockMojoInterfaceImpl (Browser - UI thread)
participant AdblockRequestClassifier (Browser - UI thread)
participant Browser - ABP thread
participant libadblockplus
participant AdblockElementHider (Browser - UI thread)
participant RenderFrameHost

[ -> AdblockURLLoaderThrottle (Renderer or Browser) : WillStartRequest(request)
AdblockURLLoaderThrottle (Renderer or Browser) ->(2) AdblockMojoInterfaceImpl (Browser - UI thread) : CheckFilterMatch(request.url, ...)
note over AdblockURLLoaderThrottle (Renderer or Browser), AdblockMojoInterfaceImpl (Browser - UI thread) : Mojo-based, in-process or inter-process communication
AdblockMojoInterfaceImpl (Browser - UI thread) -> AdblockRequestClassifier (Browser - UI thread) : CheckFilterMatch(request.url, ...)
AdblockRequestClassifier (Browser - UI thread) ->(2) Browser - ABP thread : CheckFilterMatchInternal()
Browser - ABP thread ->libadblockplus: Matches(url, ...)
libadblockplus -->Browser - ABP thread:
Browser - ABP thread ->libadblockplus: IsContentAllowlisted(url, ...)
libadblockplus -->Browser - ABP thread:
Browser - ABP thread -->(2) AdblockRequestClassifier (Browser - UI thread) : OnCheckFilterMatchComplete()
AdblockRequestClassifier (Browser - UI thread) --> AdblockMojoInterfaceImpl (Browser - UI thread): callback.Run(result)
note over AdblockURLLoaderThrottle (Renderer or Browser), AdblockMojoInterfaceImpl (Browser - UI thread) : Mojo-based, in-process or inter-process communication
AdblockMojoInterfaceImpl (Browser - UI thread) -->(2) AdblockURLLoaderThrottle (Renderer or Browser): OnFilterMatchResult(request.url, ..., result)
AdblockURLLoaderThrottle (Renderer or Browser) --> [ : request->Resume() / request->CancelWithError()
opt when request blocked
note over AdblockRequestClassifier (Browser - UI thread), AdblockElementHider (Browser - UI thread): collapse whitespace left after blocked resource
AdblockRequestClassifier (Browser - UI thread) -> AdblockElementHider (Browser - UI thread): HideBlockedElement()
AdblockElementHider (Browser - UI thread) -> AdblockElementHider (Browser - UI thread): GenerateBlockedElemhideJavaScript()
AdblockElementHider (Browser - UI thread) -> RenderFrameHost: ExecuteJavaScriptInIsolatedWorld()
end
